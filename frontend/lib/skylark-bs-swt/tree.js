/**
 * skylark-bs-swt - The skylark bootstrap standard widget tookit
 * @author Hudaokeji, Inc.
 * @version v0.9.0-beta
 * @link https://github.com/skylarkui/skylark-bs-swt/
 * @license MIT
 */
define(["skylark-utils/langx","skylark-utils/browser","skylark-utils/eventer","skylark-utils/noder","skylark-utils/geom","skylark-utils/velm","skylark-utils/query","./sbswt"],function(e,t,n,r,l,i,a,s){function o(e,t){e.addClass("tree-selected"),"item"===e.data("type")&&t.hasClass("fueluxicon-bullet")&&t.removeClass("fueluxicon-bullet").addClass("glyphicon-ok")}function d(e,t){e.removeClass("tree-selected"),"item"===e.data("type")&&t.hasClass("glyphicon-ok")&&t.removeClass("glyphicon-ok").addClass("fueluxicon-bullet")}function c(t,n,r){return e.each(r.$elements,function(e,t){var l=a(t);l[0]!==n.$element[0]&&r.dataForEvent.push(a(l).data())}),n.$element.hasClass("tree-selected")?(d(n.$element,n.$icon),r.eventType="deselected"):(o(n.$element,n.$icon),r.eventType="selected",r.dataForEvent.push(n.elementData)),r}function f(e,t,n){return n.$elements[0]!==t.$element[0]?(e.deselectAll(e.$element),o(t.$element,t.$icon),n.eventType="selected",n.dataForEvent=[t.elementData]):(d(t.$element,t.$icon),n.eventType="deselected",n.dataForEvent=[]),n}var h=a.fn.tree,u=s.Tree=s.WidgetBase.inherit({klassName:"Tree",init:function(t,n){this.$element=a(t),this.options=e.mixin({},a.fn.tree.defaults,n),this.$element.attr("tabindex","0"),this.options.itemSelect&&this.$element.on("click.fu.tree",".tree-item",e.proxy(function(e){this.selectItem(e.currentTarget)},this)),this.$element.on("click.fu.tree",".tree-branch-name",e.proxy(function(e){this.toggleFolder(e.currentTarget)},this)),this.$element.on("click.fu.tree",".tree-overflow",e.proxy(function(e){this.populate(a(e.currentTarget))},this)),this.options.folderSelect&&(this.$element.addClass("tree-folder-select"),this.$element.off("click.fu.tree",".tree-branch-name"),this.$element.on("click.fu.tree",".icon-caret",e.proxy(function(e){this.toggleFolder(a(e.currentTarget).parent())},this)),this.$element.on("click.fu.tree",".tree-branch-name",e.proxy(function(e){this.selectFolder(a(e.currentTarget))},this))),this.$element.on("focus",function(){var e=a(this);p(e,e)}),this.$element.on("keydown",function(e){return $(a(this),e)}),this.render()},deselectAll:function(e){var t=e||this.$element,n=a(t).find(".tree-selected");return n.each(function(e,t){var n=a(t);b(n),d(n,n.find(".glyphicon"))}),n},destroy:function(){return this.$element.find("li:not([data-template])").remove(),this.$element.remove(),this.$element[0].outerHTML},render:function(){this.populate(this.$element)},populate:function(t,n){var r=this,l=t.hasClass("tree-overflow"),i=t.hasClass("tree")?t:t.parent(),a=i.hasClass("tree");l&&!a&&(i=i.parent());var s=i.data();l&&(s.overflow=t.data());var o=n||!1;l&&(a?t.replaceWith(i.find("> .tree-loader").remove()):t.remove());var d=i.find(".tree-loader:last");o===!1&&d.removeClass("hide hidden"),this.options.dataSource(s?s:{},function(t){e.each(t.data,function(t,n){var l=n.type;"folder"===n.type&&(l="branch");var s=r.$element.find("[data-template=tree"+l+"]:eq(0)").clone().removeClass("hide hidden").removeData("template").removeAttr("data-template");s.find(".tree-"+l+"-name > .tree-label").html(n.text||n.name),s.data(n);var o=n.attr||n.dataAttributes||[];e.each(o,function(e,t){switch(e){case"cssClass":case"class":case"className":s.addClass(t);break;case"data-icon":s.find(".icon-item").removeClass().addClass("icon-item "+t),s.attr(e,t);break;case"id":s.attr(e,t),s.attr("aria-labelledby",t+"-label"),s.find(".tree-branch-name > .tree-label").attr("id",t+"-label");break;default:s.attr(e,t)}}),a?i.append(s):i.find(".tree-branch-children:eq(0)").append(s)}),i.find(".tree-loader").addClass("hidden"),r.$element.trigger("loaded.fu.tree",i)})},selectTreeNode:function(e,t){var n={};n.$element=a(e);var r={};r.$elements=this.$element.find(".tree-selected"),r.dataForEvent=[],"folder"===t?(n.$element=n.$element.closest(".tree-branch"),n.$icon=n.$element.find(".icon-folder")):n.$icon=n.$element.find(".icon-item"),n.elementData=n.$element.data(),g(n.$element),r=this.options.multiSelect?c(this,n,r):f(this,n,r),v(this.$element,n.$element),this.$element.trigger(r.eventType+".fu.tree",{target:n.elementData,selected:r.dataForEvent}),n.$element.trigger("updated.fu.tree",{selected:r.dataForEvent,item:n.$element,eventType:r.eventType})},discloseFolder:function(e){var t=a(e),n=t.closest(".tree-branch"),r=n.find(".tree-branch-children"),l=r.eq(0);n.addClass("tree-open"),n.attr("aria-expanded","true"),l.removeClass("hide hidden"),n.find("> .tree-branch-header .icon-folder").eq(0).removeClass("glyphicon-folder-close").addClass("glyphicon-folder-open");var i=this.$element,s=function(){i.trigger("disclosedFolder.fu.tree",n.data())};r.children().length?s():(i.one("loaded.fu.tree",s),this.populate(r))},closeFolder:function(e){var t=a(e),n=t.closest(".tree-branch"),r=n.find(".tree-branch-children"),l=r.eq(0);n.removeClass("tree-open"),n.attr("aria-expanded","false"),l.addClass("hidden"),n.find("> .tree-branch-header .icon-folder").eq(0).removeClass("glyphicon-folder-open").addClass("glyphicon-folder-close"),this.options.cacheItems||l.empty(),this.$element.trigger("closed.fu.tree",n.data())},toggleFolder:function(e){var t=a(e);t.find(".glyphicon-folder-close").length?this.discloseFolder(e):t.find(".glyphicon-folder-open").length&&this.closeFolder(e)},selectFolder:function(e){this.options.folderSelect&&this.selectTreeNode(e,"folder")},selectItem:function(e){this.options.itemSelect&&this.selectTreeNode(e,"item")},selectedItems:function(){var t=this.$element.find(".tree-selected"),n=[];return e.each(t,function(e,t){n.push(a(t).data())}),n},collapse:function(){var e=this,t=[],n=function r(n,l){t.push(l),0===e.$element.find(".tree-branch.tree-open:not('.hidden, .hide')").length&&(e.$element.trigger("closedAll.fu.tree",{tree:e.$element,reportedClosed:t}),e.$element.off("loaded.fu.tree",e.$element,r))};e.$element.on("closed.fu.tree",n),e.$element.find(".tree-branch.tree-open:not('.hidden, .hide')").each(function(){e.closeFolder(this)})},discloseVisible:function(){var e=this,t=e.$element.find(".tree-branch:not('.tree-open, .hidden, .hide')"),n=[],r=function l(r,i){n.push(i),n.length===t.length&&(e.$element.trigger("disclosedVisible.fu.tree",{tree:e.$element,reportedOpened:n}),e.$element.off("loaded.fu.tree",e.$element,l))};e.$element.on("loaded.fu.tree",r),e.$element.find(".tree-branch:not('.tree-open, .hidden, .hide')").each(function(){e.discloseFolder(a(this).find(".tree-branch-header"))})},discloseAll:function(){var e=this;"undefined"==typeof e.$element.data("disclosures")&&e.$element.data("disclosures",0);var t=e.options.disclosuresUpperLimit>=1&&e.$element.data("disclosures")>=e.options.disclosuresUpperLimit,n=0===e.$element.find(".tree-branch:not('.tree-open, .hidden, .hide')").length;if(n)e.$element.trigger("disclosedAll.fu.tree",{tree:e.$element,disclosures:e.$element.data("disclosures")}),e.options.cacheItems||e.$element.one("closeAll.fu.tree",function(){e.$element.data("disclosures",0)});else{if(t&&(e.$element.trigger("exceededDisclosuresLimit.fu.tree",{tree:e.$element,disclosures:e.$element.data("disclosures")}),!e.$element.data("ignore-disclosures-limit")))return;e.$element.data("disclosures",e.$element.data("disclosures")+1),e.$element.one("disclosedVisible.fu.tree",function(){e.discloseAll()}),e.discloseVisible()}},refreshFolder:function(e){var t=e.closest(".tree-branch"),n=t.find(".tree-branch-children");n.eq(0).empty(),t.hasClass("tree-open")?this.populate(n,!1):this.populate(n,!0),this.$element.trigger("refreshedFolder.fu.tree",t.data())}});u.prototype.closeAll=u.prototype.collapse,u.prototype.openFolder=u.prototype.discloseFolder,u.prototype.getValue=u.prototype.selectedItems;var m=function(e,t){e.attr("tabindex",-1),e.find("li").attr("tabindex",-1),t&&t.length>0&&t.attr("tabindex",0)},p=function(e,t){var n=t.find(".tree-selected:first");n.length<=0&&(n=t.find('li:not(".hidden"):first')),v(e,n)},v=function(e,t){m(e,t),e.attr("aria-activedescendant",t.attr("id")),t.focus(),e.trigger("setFocus.fu.tree",t)},$=function(e,t){if(t.isDefaultPrevented()||t.isPropagationStopped())return!1;var n=t.originalEvent.target,r=a(n),l=r.hasClass("tree-open"),i=!1,s=!0,o=function(){e.trigger("keyboardNavigated.fu.tree",t,r)};switch(t.which){case 13:case 32:var d=e.hasClass("tree-folder-select"),c=r.hasClass("tree-branch"),f=r.hasClass("tree-item");s=!1,c?d?(e.one("selected.fu.tree deselected.fu.tree",o),e.tree("selectFolder",r.find(".tree-branch-header")[0])):(e.one("loaded.fu.tree closed.fu.tree",o),e.tree("toggleFolder",r.find(".tree-branch-header")[0])):f?(e.one("selected.fu.tree",o),e.tree("selectItem",r)):(h=a(r.prevAll().not(".hidden")[0]),r.click(),e.one("loaded.fu.tree",function(){m=a(h.nextAll().not(".hidden")[0]),v(e,m),o()})),i=!0;break;case 35:v(e,e.find('li:not(".hidden"):last')),i=!0;break;case 36:v(e,e.find('li:not(".hidden"):first')),i=!0;break;case 37:l?(s=!1,e.one("closed.fu.tree",o),e.tree("closeFolder",n)):v(e,a(r.parents("li")[0])),i=!0;break;case 38:var h=[];if(h=a(r.prevAll().not(".hidden")[0]),h.hasClass("tree-open")){var u=h.find('li:not(".hidden"):last');u.length>0&&(h=a(u[0]))}h.length<1&&(h=a(r.parents("li")[0])),v(e,h),i=!0;break;case 39:l?p(e,r):(s=!1,e.one("disclosed.fu.tree",o),e.tree("discloseFolder",n)),i=!0;break;case 40:var m=a(r.find('li:not(".hidden"):first')[0]);(!l||m.length<=0)&&(m=a(r.nextAll().not(".hidden")[0])),m.length<1&&(m=a(a(r.parents("li")[0]).nextAll().not(".hidden")[0])),v(e,m),i=!0;break;default:return!0}return i&&(t.preventDefault(),t.stopPropagation(),s&&o()),!0},g=function(e){e.attr("aria-selected",!0)},b=function(e){e.attr("aria-selected",!1)};a.fn.tree=function(e){var t,n=Array.prototype.slice.call(arguments,1),r=this.each(function(){var r=a(this),l=r.data("fu.tree"),i="object"==typeof e&&e;l||(r.data("fu.tree",l=new u(this,i)),r.trigger("initialized.fu.tree")),"string"==typeof e&&(t=l[e].apply(l,n))});return void 0===t?r:t};var y=function k(e,t){var n=a.isEmptyObject(e);if(n)return t;if(void 0===t)return!1;for(var r=0;r<t.length;r++){var l=t[r];if(l.attr&&e.attr&&l.attr.id===e.attr.id)return l.children;if(l.children){var i=k(e,l.children);if(i)return i}}return!1};return a.fn.tree.defaults={staticData:[],dataSource:function(e,t){if(this.staticData.length>0){var n=y(e,this.staticData);t({data:n})}},multiSelect:!1,cacheItems:!0,folderSelect:!0,itemSelect:!0,disclosuresUpperLimit:0},a.fn.tree.Constructor=u,a.fn.tree.noConflict=function(){return a.fn.tree=h,this},a.fn.tree});
//# sourceMappingURL=sourcemaps/tree.js.map
